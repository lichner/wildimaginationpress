---
layout: default
---

<section class="book-hero">
  <!-- Breadcrumb Navigation -->
  <div class="breadcrumbs">
    <div class="container">
      <nav aria-label="Breadcrumb">
        <ol class="breadcrumb-list">
          <li class="breadcrumb-item"><a href="{{ '/' | relative_url }}">Home</a></li>
          <li class="breadcrumb-item"><a href="{{ '/books/' | relative_url }}">Books</a></li>
          <li class="breadcrumb-item" aria-current="page" title="{{ page.title }}">
            {% if page.breadcrumb_title %}
              {{ page.breadcrumb_title }}
            {% elsif page.title.size > 35 %}
              <span class="breadcrumb-full">{{ page.title }}</span>
              <span class="breadcrumb-short">{{ page.title | truncatewords: 4, "..." }}</span>
            {% else %}
              {{ page.title }}
            {% endif %}
          </li>
        </ol>
      </nav>
    </div>
  </div>
  
  <div class="container">
    <div class="book-hero-content">
      <div class="book-cover-large">
        {% if page.cover_image %}
          <img src="{{ page.cover_image | relative_url }}" alt="{{ page.title }}" class="book-cover-img">
        {% else %}
          <div class="book-placeholder-large">
            <!-- <h4 class="book-title-large">{{ page.title }}</h4> -->
            <p class="cover-coming-soon-large">Cover Coming Soon</p>
          </div>
        {% endif %}
        
        {% include book-preview.html %}
      </div>
      
      <div class="book-details-main">
        {% if page.series %}
        <div class="series-badge">
          <span class="series-name">{{ page.series.name }}</span>
          <span class="series-number">Book {{ page.series.number }} of {{ page.series.total_books }}</span>
        </div>
        {% endif %}
        
        <h1>{{ page.title }}</h1>
        {% if page.sub_title and page.sub_title != "" %}
          <p class="book-subtitle">{{ page.sub_title }}</p>
        {% endif %}
        <p class="book-author">
          by 
          {% if page.author.url %}
            <a href="{{ page.author.url | relative_url }}">{% if page.author.name %}{{ page.author.name }}{% else %}{{ page.author }}{% endif %}</a>
          {% else %}
            {% if page.author.name %}{{ page.author.name }}{% else %}{{ page.author }}{% endif %}
          {% endif %}
        </p>
        
        <div class="book-meta">
          {% if page.age_range %}
          <div class="meta-item">
            <strong>Age Range:</strong> {{ page.age_range }}
          </div>
          {% endif %}
          
          {% if page.category_meta or page.category %}
          <div class="meta-item meta-item-category">
            <strong>Category:</strong>
            <div class="category-badges" aria-label="Book categories">
              {% if page.category_meta and page.category_meta.primary %}
                <span class="category-badge primary" title="{{ page.category_meta.primary }}">{{ page.category_meta.primary }}</span>
                {% if page.category_meta.secondary %}
                <span class="category-badge secondary" title="{{ page.category_meta.secondary }}">{{ page.category_meta.secondary }}</span>
                {% endif %}
              {% elsif page.category %}
                <span class="category-badge primary" title="{{ page.category }}">{{ page.category }}</span>
              {% endif %}
            </div>
          </div>
          {% endif %}
          
          {% if page.publisher %}
          <div class="meta-item">
            <strong>Publisher:</strong> {{ page.publisher }}
          </div>
          {% endif %}
          
          {% if page.status %}
          <div class="meta-item">
            <strong>Status:</strong> 
            <span class="status-badge status-{{ page.status | slugify }}">{{ page.status }}</span>
          </div>
          {% endif %}
        </div>
        
        {% if page.features %}
        <div class="book-features-main">
          {% for feature in page.features %}
          <span class="feature-tag">{{ feature }}</span>
          {% endfor %}
        </div>
        {% endif %}
        
        <div id="buy" class="book-actions">
          {% assign has_primary_paperback = false %}
          {% if page.amazon and page.amazon.paperback and page.amazon.paperback.status == "available" %}
            {% assign marketplaces = page.amazon.paperback.marketplaces %}
            {% if marketplaces %}
              {% assign has_primary_paperback = true %}
              <div class="primary-purchase-row">
                <p class="availability-note">Available now · Paperback on Amazon</p>
                <button 
                   class="btn-format paperback primary-paperback btn-marketplace-trigger" 
                   data-format="paperback"
                   {% if page.amazon.paperback.asin != "" %}data-asin="{{ page.amazon.paperback.asin }}"{% endif %}
                   onclick="openMarketplaceModal()">
                  <span class="format-name">Buy on Amazon</span>
                  {% if page.amazon.paperback.price %}
                  <span class="format-price">{{ page.amazon.paperback.price }}</span>
                  {% endif %}
                </button>
              </div>
            {% elsif page.amazon.paperback.url and page.amazon.paperback.url != '' and page.amazon.paperback.url != '#' %}
              {% assign has_primary_paperback = true %}
              <div class="primary-purchase-row">
                <p class="availability-note">Available now · Paperback on Amazon</p>
                <a href="{{ page.amazon.paperback.url }}" 
                   class="btn-format paperback primary-paperback" 
                   data-format="paperback"
                   {% if page.amazon.paperback.asin != "" %}data-asin="{{ page.amazon.paperback.asin }}"{% endif %}
                   data-track="amazon">
                  <span class="format-name">Buy Paperback</span>
                  {% if page.amazon.paperback.price %}
                  <span class="format-price">{{ page.amazon.paperback.price }}</span>
                  {% endif %}
                </a>
              </div>
            {% endif %}
          {% endif %}
          {% comment %} Check if any format is available using new multi-format structure {% endcomment %}
          {% assign has_available_format = false %}
          {% if page.amazon.kindle.status == "available" and page.amazon.kindle.url != "" and page.amazon.kindle.url != "#" %}
            {% assign has_available_format = true %}
          {% elsif page.amazon.paperback.status == "available" and page.amazon.paperback.url != "" and page.amazon.paperback.url != "#" or page.amazon.paperback.status == "available" and page.amazon.paperback.marketplaces %}
            {% assign has_available_format = true %}
          {% elsif page.amazon.audiobook.status == "available" and page.amazon.audiobook.url != "" and page.amazon.audiobook.url != "#" %}
            {% assign has_available_format = true %}
          {% endif %}
          
          {% if has_available_format %}
            <div class="format-selector">
              {% if page.amazon.kindle.status == "available" and page.amazon.kindle.url != "" and page.amazon.kindle.url != "#" %}
              <a href="{{ page.amazon.kindle.url }}" 
                 class="btn-format kindle" 
                 data-format="kindle"
                 {% if page.amazon.kindle.asin != "" %}data-asin="{{ page.amazon.kindle.asin }}"{% endif %}
                 data-track="amazon">
                <span class="format-name">Kindle eBook</span>
                {% if page.amazon.kindle.price %}
                <span class="format-price">{{ page.amazon.kindle.price }}</span>
                {% endif %}
                {% if page.amazon.kindle.ku_eligible %}
                <span class="ku-badge">KU</span>
                {% endif %}
              </a>
              {% endif %}
              
              {% if has_primary_paperback == false and page.amazon.paperback.status == "available" %}
                {% if page.amazon.paperback.marketplaces %}
                  {%- assign primary_market = page.amazon.paperback.marketplaces.au | default: page.amazon.paperback.marketplaces.first[1] -%}
                  <a href="{{ primary_market.url }}" 
                     class="btn-format paperback" 
                     data-format="paperback"
                     {% if page.amazon.paperback.asin != "" %}data-asin="{{ page.amazon.paperback.asin }}"{% endif %}
                     data-track="amazon">
                    <span class="format-name">Buy Paperback — {{ primary_market.name }}</span>
                    {% if page.amazon.paperback.price %}
                    <span class="format-price">{{ page.amazon.paperback.price }}</span>
                    {% endif %}
                  </a>
                {% elsif page.amazon.paperback.url != "" and page.amazon.paperback.url != "#" %}
                  <a href="{{ page.amazon.paperback.url }}" 
                     class="btn-format paperback" 
                     data-format="paperback"
                     {% if page.amazon.paperback.asin != "" %}data-asin="{{ page.amazon.paperback.asin }}"{% endif %}
                     data-track="amazon">
                    <span class="format-name">Buy Paperback</span>
                    {% if page.amazon.paperback.price %}
                    <span class="format-price">{{ page.amazon.paperback.price }}</span>
                    {% endif %}
                  </a>
                {% endif %}
              {% endif %}
              
              {% if page.amazon.audiobook.status == "available" and page.amazon.audiobook.url != "" and page.amazon.audiobook.url != "#" %}
              <a href="{{ page.amazon.audiobook.url }}" 
                 class="btn-format audiobook" 
                 data-format="audiobook"
                 {% if page.amazon.audiobook.asin != "" %}data-asin="{{ page.amazon.audiobook.asin }}"{% endif %}
                 data-track="amazon">
                <span class="format-name">Audiobook</span>
                {% if page.amazon.audiobook.price %}
                <span class="format-price">{{ page.amazon.audiobook.price }}</span>
                {% endif %}
              </a>
              {% endif %}
            </div>
          {% else %}
            <a href="{{ '/#contact' | relative_url }}" class="cta-button cta-button-status">
              Notify Me When Available
            </a>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Book Structured Data -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Book",
  "name": "{% if page.sub_title and page.sub_title != '' %}{{ page.title }}: {{ page.sub_title }}{% else %}{{ page.title }}{% endif %}",
  {% if page.sub_title and page.sub_title != "" %}
  "alternativeHeadline": "{{ page.sub_title }}",
  {% endif %}
  "author": {
    "@type": "Person",
    "name": "{% if page.author.name %}{{ page.author.name }}{% else %}{{ page.author }}{% endif %}"
    {% if page.author.url %},
    "url": "{{ page.author.url | absolute_url }}"
    {% elsif page.author_url %},
    "url": "{{ page.author_url | absolute_url }}"
    {% endif %},
    "sameAs": [
      "https://x.com/wildimaginpress",
      "https://instagram.com/wildimaginationpress"
    ]
  },
  "publisher": {
    "@type": "Organization",
    "name": "{{ page.publisher }}",
    "url": "{{ site.url }}",
    "logo": {
      "@type": "ImageObject",
      "url": "{{ '/assets/images/wild-imagination-logo.jpg' | absolute_url }}"
    }
  },
  {% if page.published_date %}
  "datePublished": "{{ page.published_date }}",
  {% endif %}
  {% if page.isbn and page.isbn != "TBA" %}
  "isbn": "{{ page.isbn }}",
  {% endif %}
  {% comment %} Use primary format from new structure, fallback to legacy format {% endcomment %}
  {% if page.amazon.paperback.status == "available" %}
  "bookFormat": "https://schema.org/Paperback",
  {% elsif page.amazon.kindle.status == "available" %}
  "bookFormat": "https://schema.org/EBook",
  {% else %}
  "bookFormat": "https://schema.org/{{ page.format | default: 'Paperback' }}",
  {% endif %}
  "image": "{{ page.cover_image | absolute_url }}",
  "description": "{{ page.description | strip_html | truncate: 160 }}",
  "inLanguage": "en-AU",
  "audience": {
    "@type": "PeopleAudience",
    "suggestedMinAge": {{ page.age_range | split: '-' | first }},
    "suggestedMaxAge": {{ page.age_range | split: '-' | last | split: ' ' | first }}
  },
  {% comment %} Multiple offers support - only from new multi-format structure {% endcomment %}
  {% assign has_offers = false %}
  {% if page.amazon.kindle.status == "available" and page.amazon.kindle.url != "" and page.amazon.kindle.url != "#" %}
    {% assign has_offers = true %}
  {% elsif page.amazon.paperback.status == "available" and page.amazon.paperback.url != "" and page.amazon.paperback.url != "#" %}
    {% assign has_offers = true %}
  {% elsif page.amazon.audiobook.status == "available" and page.amazon.audiobook.url != "" and page.amazon.audiobook.url != "#" %}
    {% assign has_offers = true %}
  {% endif %}
  {% if has_offers %}
  "offers": [
    {% if page.amazon.kindle.status == "available" and page.amazon.kindle.url != "" and page.amazon.kindle.url != "#" %}
    {
      "@type": "Offer",
      "url": "{{ page.amazon.kindle.url }}",
      "priceCurrency": "AUD",
      {% if page.amazon.kindle.price %}
      "price": "{{ page.amazon.kindle.price | remove: '$' | remove: 'AUD' | strip }}",
      {% endif %}
      "availability": "https://schema.org/InStock",
      "itemOffered": {
        "@type": "Book",
        "bookFormat": "https://schema.org/EBook"
      }
    {% assign has_more_offers = false %}
    {% if page.amazon.paperback.status == "available" and page.amazon.paperback.url != "" and page.amazon.paperback.url != "#" %}
      {% assign has_more_offers = true %}
    {% elsif page.amazon.audiobook.status == "available" and page.amazon.audiobook.url != "" and page.amazon.audiobook.url != "#" %}
      {% assign has_more_offers = true %}
    {% endif %}
    {% if has_more_offers %},{% endif %}
    {% endif %}
    {% if page.amazon.paperback.status == "available" and page.amazon.paperback.url != "" and page.amazon.paperback.url != "#" %}
    {
      "@type": "Offer",
      {% if page.amazon.paperback.marketplaces %}{% assign _primary_offer = page.amazon.paperback.marketplaces.au | default: page.amazon.paperback.marketplaces.first[1] %}
      "url": "{{ _primary_offer.url }}",
      {% else %}
      "url": "{{ page.amazon.paperback.url }}",
      {% endif %}
      "priceCurrency": "AUD",
      {% if page.amazon.paperback.price %}
      "price": "{{ page.amazon.paperback.price | remove: '$' | remove: 'AUD' | strip }}",
      {% endif %}
      "availability": "https://schema.org/InStock",
      "itemOffered": {
        "@type": "Book",
        "bookFormat": "https://schema.org/Paperback"
      }
    }{% if page.amazon.audiobook.status == "available" and page.amazon.audiobook.url != "" and page.amazon.audiobook.url != "#" %},{% endif %}
    {% endif %}
    {% if page.amazon.audiobook.status == "available" and page.amazon.audiobook.url != "" and page.amazon.audiobook.url != "#" %}
    {
      "@type": "Offer",
      "url": "{{ page.amazon.audiobook.url }}",
      "priceCurrency": "AUD",
      {% if page.amazon.audiobook.price %}
      "price": "{{ page.amazon.audiobook.price | remove: '$' | remove: 'AUD' | strip }}",
      {% endif %}
      "availability": "https://schema.org/InStock",
      "itemOffered": {
        "@type": "Audiobook",
        "bookFormat": "https://schema.org/AudiobookFormat"
      }
    }
    {% endif %}
  ],
  {% endif %}
  "numberOfPages": {{ page.page_count | default: 32 }},
  {% if page.category_meta and page.category_meta.primary %}
  "genre": "{{ page.category_meta.primary }}",
  {% elsif page.category %}
  "genre": "{{ page.category }}",
  {% endif %}
  {% if page.bisac_codes %}
  "keywords": "{{ page.bisac_codes | join: ', ' }}",
  {% endif %}
}
</script>

<!-- Breadcrumb Structured Data -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Home",
      "item": "{{ site.url }}"
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "Books",
      "item": "{{ site.url }}/books/"
    },
    {
      "@type": "ListItem",
      "position": 3,
      "name": "{{ page.title }}",
      "item": "{{ page.url | absolute_url }}"
    }
  ]
}
</script>

<section class="book-description">
  <div class="container">
    <h2>About This Book</h2>
    <div class="description-content">{{ page.full_description | markdownify }}</div>
  </div>
</section>

{% if page.faq %}
<section class="book-faq">
  <div class="container">
    <h2>Frequently Asked Questions</h2>
    
    <div class="faq-list">
      {% for item in page.faq %}
      <div class="faq-item">
        <h3 class="faq-question">{{ item.question }}</h3>
        <div class="faq-answer">{{ item.answer | markdownify }}</div>
      </div>
      {% endfor %}
    </div>
  </div>
</section>

<!-- FAQ Structured Data -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "url": "{{ page.url | absolute_url }}",
  {% if page.cover_image %}
  "image": "{{ page.cover_image | absolute_url }}",
  {% endif %}
  "mainEntity": [
    {% for item in page.faq %}
    {
      "@type": "Question",
      "name": "{{ item.question }}",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "{{ item.answer | strip_html }}"
      }
    }{% unless forloop.last %},{% endunless %}
    {% endfor %}
  ]
}
</script>
{% endif %}

{% if page.series %}
<section class="series-books">
  <div class="container">
    <h2>{{ page.series.name }} Series</h2>
    <p class="series-description">Book {{ page.series.number }} of {{ page.series.total_books }} in the series</p>
    
    <div class="books-grid">
      {% assign series_books = site.books | where_exp: "book", "book.series.name == page.series.name" | sort: "series.number" %}
      {% for book in series_books %}
        <div class="book-card-small {% if book.url == page.url %}current-book{% endif %}">
          <div class="book-cover-small book-cover-square">
            <a href="{{ book.url | relative_url }}" class="book-cover-link">
              {% if book.cover_image %}
                {% assign cover_base = book.cover_image | replace: '-cover-large.jpg', '' | replace: '-cover.jpg', '' | replace: '.jpg', '' %}
                {% assign square_small = cover_base | append: '-cover-square-small.jpg' %}
                {% assign square_medium = cover_base | append: '-cover-square-medium.jpg' %}
                {% assign square_large = cover_base | append: '-cover-square-large.jpg' %}
                <img 
                  src="{{ square_medium | relative_url }}" 
                  srcset="{{ square_small | relative_url }} 250w, {{ square_medium | relative_url }} 400w, {{ square_large | relative_url }} 600w"
                  sizes="(max-width: 768px) 250px, 400px"
                  alt="{{ book.title }}" 
                  loading="lazy">
              {% else %}
                <div class="book-placeholder-small">
                  <span class="cover-coming-soon-small">Cover Coming Soon</span>
                </div>
              {% endif %}
            </a>
            {% if book.series.number %}
            <div class="series-book-number">Book {{ book.series.number }}</div>
            {% endif %}
          </div>
          <div class="book-info-small">
            <h3><a href="{{ book.url | relative_url }}">{{ book.title }}</a></h3>
            {% if book.sub_title and book.sub_title != "" %}
              <p class="book-subtitle-small">{{ book.sub_title }}</p>
            {% endif %}
            {% if book.author %}
              <p class="book-author-small">
                by 
                {% if book.author.name %}
                  {% if book.author.url %}
                    <a href="{{ book.author.url | relative_url }}">{{ book.author.name }}</a>
                  {% else %}
                    {{ book.author.name }}
                  {% endif %}
                {% else %}
                  {{ book.author }}
                {% endif %}
              </p>
            {% endif %}
            {% if book.amazon and book.amazon.paperback and book.amazon.paperback.status == "available" %}
              {% if book.amazon.paperback.marketplaces %}
                <a href="{{ book.url | relative_url }}#buy"
                   class="book-status-buy-pill"
                   data-format="paperback"
                   {% if book.amazon.paperback.asin != "" %}data-asin="{{ book.amazon.paperback.asin }}"{% endif %}>
                  Buy on Amazon
                </a>
              {% elsif book.amazon.paperback.url != '' and book.amazon.paperback.url != '#' %}
                <a href="{{ book.amazon.paperback.url }}"
                   class="book-status-buy-pill"
                   data-format="paperback"
                   {% if book.amazon.paperback.asin != "" %}data-asin="{{ book.amazon.paperback.asin }}"{% endif %}
                   data-track="amazon">
                  Buy on Amazon
                </a>
              {% else %}
                <p class="book-status-small">{{ book.status }}</p>
              {% endif %}
            {% else %}
            <p class="book-status-small">{{ book.status }}</p>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
</section>
{% endif %}

{% if site.books.size > 1 %}
<section class="related-books">
  <div class="container">
    <h2>More Books</h2>
    <div class="books-grid">
      {% assign sorted_books = site.books | sort: "order" %}
      {% for book in sorted_books %}
        {% unless book.url == page.url %}
        <div class="book-card-small">
          <div class="book-cover-small book-cover-square">
            <a href="{{ book.url | relative_url }}" class="book-cover-link">
              {% if book.cover_image %}
                {% assign cover_base = book.cover_image | replace: '-cover-large.jpg', '' | replace: '-cover.jpg', '' | replace: '.jpg', '' %}
                {% assign square_small = cover_base | append: '-cover-square-small.jpg' %}
                {% assign square_medium = cover_base | append: '-cover-square-medium.jpg' %}
                {% assign square_large = cover_base | append: '-cover-square-large.jpg' %}
                <img 
                  src="{{ square_medium | relative_url }}" 
                  srcset="{{ square_small | relative_url }} 250w, {{ square_medium | relative_url }} 400w, {{ square_large | relative_url }} 600w"
                  sizes="(max-width: 768px) 250px, 400px"
                  alt="{{ book.title }}" 
                  loading="lazy">
              {% else %}
                <div class="book-placeholder-small">
                  <!-- <span class="book-title-small">{{ book.title }}</span> -->
                  <span class="cover-coming-soon-small">Cover Coming Soon</span>
                </div>
              {% endif %}
            </a>
          </div>
          <div class="book-info-small">
            <h3><a href="{{ book.url | relative_url }}">{{ book.title }}</a></h3>
            {% if book.sub_title and book.sub_title != "" %}
              <p class="book-subtitle-small">{{ book.sub_title }}</p>
            {% endif %}
            {% if book.author %}
              <p class="book-author-small">
                by 
                {% if book.author.name %}
                  {% if book.author.url %}
                    <a href="{{ book.author.url | relative_url }}">{{ book.author.name }}</a>
                  {% else %}
                    {{ book.author.name }}
                  {% endif %}
                {% else %}
                  {{ book.author }}
                {% endif %}
              </p>
            {% endif %}
            {% if book.amazon and book.amazon.paperback and book.amazon.paperback.status == "available" and book.amazon.paperback.url != "" and book.amazon.paperback.url != "#" %}
            <a href="{{ book.amazon.paperback.url }}"
               class="book-status-buy-pill"
               data-format="paperback"
               {% if book.amazon.paperback.asin != "" %}data-asin="{{ book.amazon.paperback.asin }}"{% endif %}
               data-track="amazon">
              Buy on Amazon
            </a>
            {% else %}
            <p class="book-status-small">{{ book.status }}</p>
            {% endif %}
          </div>
        </div>
        {% endunless %}
      {% endfor %}
    </div>
  </div>
</section>
{% endif %}

{% if page.amazon and page.amazon.paperback and page.amazon.paperback.marketplaces %}
<!-- Marketplace Selector Modal -->
<div id="marketplace-modal" class="marketplace-modal" aria-hidden="true" role="dialog" aria-labelledby="marketplace-modal-title">
  <div class="marketplace-modal-container">
    <button class="marketplace-modal-close" data-action="close-modal" aria-label="Close marketplace selector">×</button>
    <div class="marketplace-modal-content">
      <div class="marketplace-modal-header">
        <h3 id="marketplace-modal-title">Choose Your Amazon Store</h3>
        <p>Select your preferred Amazon marketplace to purchase {{ page.title }}</p>
      </div>
      <div class="marketplace-list">
        {%- for pair in page.amazon.paperback.marketplaces -%}
          {%- assign key = pair[0] -%}
          {%- assign market = pair[1] -%}
          <a href="{{ market.url }}" 
             class="marketplace-option {% if market.primary %}primary{% endif %}" 
             data-track="amazon"
             data-marketplace="{{ key }}"
             {% if page.amazon.paperback.asin != "" %}data-asin="{{ page.amazon.paperback.asin }}"{% endif %}>
            {% if market.flag %}<span class="marketplace-flag">{{ market.flag }}</span>{% endif %}
            <div class="marketplace-info">
              <span class="marketplace-name">{{ market.name }}</span>
              <span class="marketplace-domain">{{ market.url | replace: 'https://', '' | replace: 'http://', '' | split: '/' | first }}</span>
            </div>
            <span class="marketplace-arrow">→</span>
          </a>
        {%- endfor -%}
      </div>
    </div>
  </div>
</div>

<script>
// Track scroll position for mobile
let scrollPosition = 0;

function openMarketplaceModal() {
  const modal = document.getElementById('marketplace-modal');
  if (modal) {
    // Save current scroll position
    scrollPosition = window.pageYOffset || document.documentElement.scrollTop;
    
    // Use requestAnimationFrame for smooth rendering
    requestAnimationFrame(() => {
      modal.classList.add('is-visible');
      modal.setAttribute('aria-hidden', 'false');
      
      // Prevent background scroll (works on all devices)
      document.body.style.overflow = 'hidden';
      document.body.style.position = 'fixed';
      document.body.style.top = `-${scrollPosition}px`;
      document.body.style.width = '100%';
      
      // Focus trap for accessibility
      requestAnimationFrame(() => {
        const firstFocusable = modal.querySelector('button, a');
        if (firstFocusable) {
          firstFocusable.focus();
        }
      });
    });
  }
}

function closeMarketplaceModal() {
  const modal = document.getElementById('marketplace-modal');
  if (modal) {
    // Use requestAnimationFrame for smooth rendering
    requestAnimationFrame(() => {
      modal.classList.remove('is-visible');
      modal.setAttribute('aria-hidden', 'true');
      
      // Restore scroll position and body styles
      document.body.style.overflow = '';
      document.body.style.position = '';
      document.body.style.top = '';
      document.body.style.width = '';
      
      // Restore scroll in next frame for smoothness
      requestAnimationFrame(() => {
        window.scrollTo(0, scrollPosition);
      });
    });
  }
}

// Initialize modal once DOM is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initMarketplaceModal);
} else {
  initMarketplaceModal();
}

function initMarketplaceModal() {
  const modal = document.getElementById('marketplace-modal');
  if (!modal || modal.dataset.initialized) return;
  
  modal.dataset.initialized = 'true';
  
  // Handle close button clicks (Safari-compatible)
  const closeButton = modal.querySelector('.marketplace-modal-close');
  if (closeButton) {
    closeButton.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      closeMarketplaceModal();
    });
  }
  
  // Handle overlay clicks (use click only, not touchend for better performance)
  modal.addEventListener('click', function(e) {
    if (e.target === modal) {
      closeMarketplaceModal();
    }
  });
  
  // Close on Escape key
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && modal.classList.contains('is-visible')) {
      closeMarketplaceModal();
    }
  });
  
  // Safari-compatible hash detection with delay
  function checkHashAndOpenModal() {
    const hash = window.location.hash;
    if (hash === '#buy') {
      // Small delay for Safari to properly parse URL
      setTimeout(function() {
        openMarketplaceModal();
        scrollToBuySection();
      }, 100);
    }
  }
  
  // Auto-open modal if URL has #buy anchor
  checkHashAndOpenModal();
  
  // Listen for hash changes (for same-page navigation)
  window.addEventListener('hashchange', checkHashAndOpenModal);
  
  // Handle clicks on #buy links (Safari-compatible event delegation)
  document.addEventListener('click', function(e) {
    // Check if clicked element or any parent is a #buy link
    let target = e.target;
    while (target && target !== document) {
      if (target.tagName === 'A' && target.getAttribute('href')) {
        const href = target.getAttribute('href');
        if (href.endsWith('#buy')) {
          if (window.location.hash === '#buy') {
            e.preventDefault();
            openMarketplaceModal();
            scrollToBuySection();
          }
          break;
        }
      }
      target = target.parentNode;
    }
  });
}

function scrollToBuySection() {
  const buySection = document.getElementById('buy');
  if (buySection) {
    buySection.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }
}
</script>
{% endif %}
